# Jetpack Compose architectural layering

https://developer.android.com/jetpack/compose/layering

このページではJetpack Composeがアーキテクチャレイヤーの概要を提供し、この設計の原則について知らせる。

Jetpack Composeは単一のプロジェクトではなく、複数のモジュールを組み合わせて構成されている。
Jetpack Composeを構成する様々なモジュールを理解することで以下が可能になる。

* 適切な抽象度を使用してアプリやライブラリを構築する
* より制御やカスタマイズをするために低レベルを扱えることを理解する
* 依存関係の最小化

## Layers

Jetpack Composeの主なレイヤーは以下。

* Material
* Foundation
* UI
* Runtime

それぞれのレイヤーは下位のレイヤーをベースに機能を組み合わすことで上位のコンポーネントを構築している。
またそれぞれのレイヤーは下位レイヤーのpublic APIをベースに構築されているためモジュールの境界を確認することができ、必要に応じて任意のレイヤーを交換することができる。

Runtime：`@Composable`, `SideEffect`, `remember`, `mutableStateOf`などComposeの実行のための基礎を提供する。UIではなくComposeのツリーを管理する必要が
ある場合のみこのレイヤーを直接利用することを検討する。
UI：`ui-text`, `ui-graphics`, `ui-tooling`など複数のモジュールによって構成されている。これらのモジュールでは`LayoutNode`, `Modifier`などUIツールキットのための基礎が実装されている。UIツールキットの基礎的なコンセプトが必要な場合のみこのレイヤーを直接利用することを検討する。
Foundation：`Row`, `Column`, `LazyColumn` などCompose UIのデザインシステムを提供する。独自のデザインシステムを構築する場合にこのレイヤーを利用することができる。
Material：Compose UIのためのMaterial Designの実装を提供する。アプリでMaterial Designを利用する場合にこのレイヤーを利用する。

## Design Principles

単一のコンポーネントではなく、一緒に組み立てることができる小さく、集中的な機能の断片を提供することがJetpack Composeの基本方針であり、このアプローチには多くの利点がある。

### Control

上位のコンポーネントはより多くのことをしてくれる傾向にあるが、ユーザが直接コントロールできる範囲は限られている。
より多くの制御が必要な場合は、下位レベルのコンポーネントを使用することができる。

例えば、コンポーネントの色をアニメーションさせたい場合は`animateColorAsState`を利用するが、開始の色を指定したい場合は`Animatable`を利用する必要がある。
`animateColorAsState`は`Animatable`を利用して構築されている。下位のレベルのAPIはより多くの制御が可能にはなるが複雑になるので必要に応じたベストなレベルを選択する必要がある。

### Customization

小さなブロックから上位のコンポーネントを組み立てることで必要に応じてコンポーネントをカスタマイズすることが容易になる。
例えば、Materialレイヤーで提供されている`Button`では以下の4つのコンポーネントが使われている。

1. `Surface`：背景、Shape、クリックのハンドリングなど
1. `CompositionLocalProvider`：有効、無効が変化した時のalphaを変更する
1. `ProvideTextStyle`：デフォルトのテキストスタイル
1. `Row`：ボタンのコンテンツのデフォルトのレイアウトポリシー

これら4つのコンポーネントを組み合わせて実装しているのでコンポーネント全体のコードは約40行しかない。
`Button`のようなコンポーネントはどのパラメータを公開するか意見が分かれており、一般的なカスタマイズを可能にすることと、コンポーネントを使いにくくするパラメータ数のバランズをとっている。
例えば、MaterialコンポーネントはMaterial Designシステムで指定されたカスタマイズを提供し、Material Designの原則に従うことを容易にしている。

コンポーネントのパラメータを超えてカスタマイズをしたい場合はレベルを下げてコンポーネントをフォークすることができる。
例えば、Material Designではボタンの背景は無地であるべきと規定されているが、グラデーションの背景が必要な場合は`Button`のパラメータではサポートされていない。
この場合は、Material Buttonの実装を参考にして独自のコンポーネントを作ることができる。

Caution：コンポーネントをカスタマウズスrために下位レイヤーを利用する場合、アクセシビリティのサポートを怠るなどして機能を低下させないようにするために、フォークしているコンポーネントを参考にする必要がある。

Materialのコンセプトを全く利用したくない場合は、Foundationレイヤーのコンポーネントを利用することで独自のデザインシステムを構築することができる。

Jetpack Composeでは上位レベルのコンポーネントがシンプルな名前を予約している。
例えば、`BasicText`を利用して`Text`を構築している。
これにより、より高いレベルでの置き換えを希望する場合に、最も発見しやすい名前で独自の実装を提供することができる。

Caution：コンポーネントをフォークするということは上流のコンポーネントに将来的に追加される機能やバグフィックスの恩恵を受けられないということ。

### Picking the right abstractions

Composeは階層化された再利用可能なコンポーネントを構築するという哲学を持っているため、常に下位レベルのブロックに手を伸ばすべきではない。
多くの高レベルなコンポーネントはより多くの機能を提供するだけではなく、アクセシビリティのサポートなどのベストプラクティスを提供している。

例えば、カスタムコンポーネントにジェスチャーのサポートを追加したい場合、`Modifier.pointerInput`を使ってゼロから構築することもできるが、より高レベルのコンポーネントである`Modifier.draggable`, `Modifier.scrolable`, `Modifier.swipeable`などがあり、そちらが良い出発点になるかもしれない。

原則として、必要とする機能を提供する最高レベルのコンポーネントをベースに構築することで、それらが含むベストプラクティスの恩恵を受けることができる。

### Learn More

独自のデザインシステムの構築例は https://github.com/android/compose-samples/tree/main/Jetsnack
